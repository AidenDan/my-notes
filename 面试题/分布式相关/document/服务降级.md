[TOC]

> author：编程界的小学生
>
> date：2021/03/10

# 一、什么是服务降级？

当服务整体负载超出预设的上线阈值或即将到来的流量预计会超过服务器压力阈值时，为了保证重要或基本的服务能正常运行，拒绝部分请求或者将一些不重要的不紧急的请求延迟使用或者暂停使用，目的是保障核心功能的正常。

# 二、为什么服务降级？

保证核心服务可用，非核心服务弱可用或者完全不可用，防止系统雪崩导致全链路瘫痪。

# 三、怎么做服务降级？

- 关闭部分服务一段时间

> 比如双11的时候，是不允许退款的，退款会提示静态页面：退款申请将于11月12日0时开通

- 拒绝部分老的请求

> 确保新请求正常响应，采取RPC队列的方式，记录请求入队、出队的时间，检查请求在队列里时间超过一定时间的开始丢弃。

- 优先级请求方式

> 非核心请求直接丢弃或者返回错误码。

- 随即拒绝方式

> 随即丢弃一定比例的请求，也就是会出现网站一会可用一会不可用的现象。

**一般在网关层和业务层做服务降级策略**

# 四、服务降级的原理？

- 线程隔离：给每一个服务分配一个小的线程池，当线程池满调用后，默认不采取排队

- 服务降级：当线程池已满或请求超时后，返回一个友好信息(例如：“网络拥挤”)，这样就不会造成阻塞

**Hystrix流程说明:**

- 1、每次调用创建一个新的HystrixCommand,把依赖调用封装在run()方法中.
- 2、执行execute()/queue做同步或异步调用.
- 4、判断熔断器(circuit-breaker)是否打开,如果打开跳到步骤8,进行降级策略,如果关闭进入步骤5.
- 5、判断线程池/队列/信号量是否跑满，如果跑满进入降级步骤8,否则继续后续步骤6.
- 6、调用HystrixCommand的run方法.运行依赖逻辑，依赖逻辑调用超时,进入步骤8.
- 7、判断逻辑是否调用成功
  - 7a、返回成功调用结果
  - 7b、调用出错，进入步骤8.
- 8、计算熔断器状态,所有的运行状态(成功, 失败, 拒绝,超时)上报给熔断器，用于统计从而判断熔断器状态.
- 9、getFallback()降级逻辑.以下四种情况将触发getFallback调用：
  　           (1):run()方法抛出非HystrixBadRequestException异常。
  　　　　(2):run()方法调用超时
  　　　　(3):熔断器开启拦截调用
  　　　　(4):线程池/队列/信号量是否跑满
  - 9a、没有实现getFallback的Command将直接抛出异常
  - 9b、fallback降级逻辑调用成功直接返回　
  - 9c、降级逻辑调用失败抛出异常
- 10、返回执行成功结果

# 五、降级和熔断啥区别？

相同点：

- 目标一致 都是从可用性和可靠性出发，为了防止系统崩溃；
- 用户体验类似 最终都让用户体验到的是某些功能暂时不可用；

不同点：

- 触发原因不同 服务熔断一般是某个服务（下游服务）故障引起，而服务降级一般是从整体负荷考虑；